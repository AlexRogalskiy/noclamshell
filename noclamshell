#!/usr/bin/env bash

while true; do
  # Yet another way to detect closed clamshell mode, BacklitDisplay disappears from the list
  # STATE=$(pmset -g powerstate | grep AppleBacklightDisplay)
  STATE=$(ioreg -r -k AppleClamshellState | grep AppleClamshellState | grep Yes)
  if [ "$STATE" ]
  then
    # This is not documented, pmset puts machine to sleep after script/shell exits, so
    # it works fine from command line or a one-off script, but fails in a loop,
    # sometimes ending up in a stall state so that only reboot helps.
    # Running it in a subshell works fine.
    (pmset sleepnow &)
  fi
  # Don't check for closed lid too often, it feels immediate anyway
  sleep 2
done
